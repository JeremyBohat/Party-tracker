<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Party Tracker with BAC & Accounts</title>
  <style>
    body{font-family:sans-serif;padding:20px;background:#fafafa}
    .hidden{display:none}
    table{border:1px solid #ccc;border-collapse:collapse;width:100%;margin-top:10px;}
    th,td{border:1px solid #aaa;padding:8px;text-align:center;}
    input,button{margin:5px;padding:8px;}
    button{cursor:pointer;}
  </style>
</head>
<body>
  <h1>Party Tracker</h1>
  <div id="auth">
    <h2>Login / Signup</h2>
    <input id="email" type="email" placeholder="Email"><br>
    <input id="password" type="password" placeholder="Password"><br>
    <button id="btnSignup">Sign Up</button>
    <button id="btnLogin">Log In</button>
  </div>

  <div id="app" class="hidden">
    <button id="btnLogout">Logout</button>
    <h2>Your Profile</h2>
    Weight (lbs): <input id="weight" type="number" min="1"><br>
    Gender:
    <select id="gender"><option value="male">Male</option><option value="female">Female</option></select>
    <button id="btnUpdateProfile">Save Profile</button>

    <h2>Add Drink</h2>
    <input id="drinks" type="number" min="1" placeholder="# Drinks">
    <button id="btnAddDrink">Add</button>

    <h2>Your BAC Estimate:</h2>
    <div id="bacDisplay">N/A</div>

    <h2>Leaderboard (Most Sober â†’ Most Drunk)</h2>
    <table id="leaderboard"><thead><tr><th>User</th><th>BAC</th><th>Total Drinks</th></tr></thead><tbody></tbody></table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
  apiKey: "AIzaSyAXZfbfJD9wT3K0S2RhY96XDrFWe7Ldnk",
  authDomain: "party-drink-tracker.firebaseapp.com",
  databaseURL: "https://party-drink-tracker-default-rtdb.firebaseio.com",
  projectId: "party-drink-tracker",
  storageBucket: "party-drink-tracker.appspot.com",
  messagingSenderId: "1051270460424",
  appId: "1:1051270460424:web:b5fb8c397688d3a25f96d",
  measurementId: "G-2DGTZNVM07"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    const authDiv = document.getElementById("auth"), appDiv = document.getElementById("app");
    const btnSignup = document.getElementById("btnSignup"), btnLogin = document.getElementById("btnLogin"), btnLogout = document.getElementById("btnLogout");
    const emailIn = document.getElementById("email"), passIn = document.getElementById("password");
    const weightIn = document.getElementById("weight"), genderIn = document.getElementById("gender"), btnUpdateProfile = document.getElementById("btnUpdateProfile");
    const drinksIn = document.getElementById("drinks"), btnAddDrink = document.getElementById("btnAddDrink");
    const bacDisplay = document.getElementById("bacDisplay"), lbBody = document.querySelector("#leaderboard tbody");

    let userProfile = null, userDrinks = [];

    btnSignup.onclick = () => {
  createUserWithEmailAndPassword(auth, emailIn.value, passIn.value)
    .catch(error => alert("Sign-up error: " + error.message));
};

btnLogin.onclick = () => {
  signInWithEmailAndPassword(auth, emailIn.value, passIn.value)
    .catch(error => alert("Login error: " + error.message));
};

    btnUpdateProfile.onclick = () => {
      const user = auth.currentUser;
      if (!user) return;
      const updates = { weight: +weightIn.value, gender: genderIn.value };
      set(ref(db, `profiles/${user.uid}`), updates);
    };

    btnAddDrink.onclick = () => {
      const user = auth.currentUser;
      const amt = parseFloat(drinksIn.value);
      if (!user || !amt) return alert("Enter # drinks");
      const t = Date.now();
      push(ref(db, `drinks/${user.uid}`), { time: t, amount: amt });
      drinksIn.value = "";
    };

    onAuthStateChanged(auth, user => {
      if (user) {
        authDiv.classList.add("hidden");
        appDiv.classList.remove("hidden");
        onValue(ref(db, `profiles/${user.uid}`), snap => {
          userProfile = snap.val();
          if (userProfile) {
            weightIn.value = userProfile.weight;
            genderIn.value = userProfile.gender;
          }
        });
        onValue(ref(db, `drinks/${user.uid}`), snap => {
          const drinks = [];
          snap.forEach(c=>drinks.push(c.val()));
          userDrinks = drinks;
          updateBACandUI();
        });
        onValue(ref(db, "profiles"), snapP => {
          const allProfiles = snapP.val()||{};
          onValue(ref(db, "drinks"), snapD => {
            const allDrinks = snapD.val()||{};
            updateLeaderboard(allProfiles, allDrinks);
          });
        });
      } else {
        authDiv.classList.remove("hidden");
        appDiv.classList.add("hidden");
      }
    });

    function estimateBAC(drinks, weight, gender, hours) {
      const r = gender==="male"?0.68:0.55;
      const bac = ((drinks * 14) / (weight * r))*100 - (0.015 * hours);
      return Math.max(0, Math.round(bac*100)/100);
    }

    function updateBACandUI() {
      if (!userProfile || !userDrinks.length) { bacDisplay.textContent="N/A"; return; }
      const totalDrinks = userDrinks.reduce((sum,e)=>sum+e.amount,0);
      const firstTime = userDrinks.reduce((min,e)=>e.time<min?e.time:min, Infinity);
      const hours = (Date.now()-firstTime)/36e5;
      const bac = estimateBAC(totalDrinks, userProfile.weight, userProfile.gender, hours);
      bacDisplay.textContent = bac.toFixed(2);
    }

    function updateLeaderboard(profiles, drinksData) {
      const list = [];
      for (const uid in profiles) {
        const p = profiles[uid];
        const drinks = (drinksData[uid]? Object.values(drinksData[uid]).map(d=>d.amount):[]);
        if (!drinks.length) continue;
        const total = drinks.reduce((a,b)=>a+b,0);
        const first = Math.min(...Object.values(drinksData[uid]).map(d=>d.time));
        const hrs = (Date.now()-first)/36e5;
        const bac = estimateBAC(total, p.weight, p.gender, hrs);
        list.push({uid, email:`${uid.substr(0,6)}`, bac, total});
      }
      list.sort((a,b)=>a.bac - b.bac);
      lbBody.innerHTML = "";
      list.forEach(u => {
        const tr = lbBody.insertRow();
        tr.insertCell().textContent = u.email;
        tr.insertCell().textContent = u.bac.toFixed(2);
        tr.insertCell().textContent = u.total;
      });
    }
  </script>
</body>
</html>
